---
// src/layouts/CaseStudyLayout.astro
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Sidebar from "../components/Sidebar.astro";

const { frontmatter } = Astro.props;
const { pathname } = Astro.url;

const navigation = [
  {
    label: "Background",
    link: "/case-study/",
    anchors: [
      { label: "Introduction", anchor: "#intro" },
      { label: "Cloud Service Models", anchor: "#cloud-service-models" },
      {
        label: "Modern Web Application Structure",
        anchor: "#modern-web-application-structure",
      },
      {
        label: "The Use Case for BaaS",
        anchor: "#use-case-for-baas",
      },
    ],
  },
  {
    label: "Where Does Pendulum Fit In?",
    link: "/case-study/where-does-pendulum-fit/",
    anchors: [
      { label: "Design Principles", anchor: "#design-principles" },
      { label: "Core Components", anchor: "#core-components" },
    ],
  },
  {
    label: "Using Pendulum",
    link: "/case-study/using-pendulum/",
    anchors: [
      { label: "Local Development", anchor: "#local-development" },
      { label: "Production", anchor: "#production" },
    ],
  },
  {
    label: "Design Decisions & Implementation Challenges",
    link: "/case-study/design-and-challenges/",
    anchors: [
      { label: "The Database — SQL vs. NoSQL", anchor: "#the-database" },
      { label: "Data Validation", anchor: "#data-validation" },
      { label: "Enabling Reactivity", anchor: "#enabling-reactivity" },
      { label: "Backend Design", anchor: "#backend-design" },
      {
        label: "Handling Reactivity in the Frontend",
        anchor: "#frontend-reactivity",
      },
      { label: "Authentication and Authorization", anchor: "#auth" },
      { label: "Admin Dashboard Design", anchor: "#admin-dashboard-design" },
    ],
  },
  {
    label: "Architecture",
    link: "/case-study/architecture/",
    anchors: [
      { label: "Local Development Experience", anchor: "#local-development" },
      { label: "Production Architecture", anchor: "#production-architecture" },
    ],
  },
  {
    label: "Future Work",
    link: "/case-study/future-work/",
    anchors: [
      { label: "Multi-Tenant Architecture", anchor: "#multi-tenant" },
      { label: "File Storage Integration", anchor: "#file-storage" },
      { label: "Greater Scalability Control", anchor: "#scalability-control" },
      {
        label: "Additional Cloud Provider Support",
        anchor: "#additional-cloud-providers",
      },
    ],
  },
];

function isCurrentPage(link: string): boolean {
  return pathname === link || pathname === link.replace(/\/$/, "");
}

function isCurrentSection(section: any): boolean {
  return isCurrentPage(section.link);
}

function shouldExpand(section: any): boolean {
  return isCurrentSection(section);
}
---

<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={frontmatter.description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Pendulum - {frontmatter.title}</title>
    <link rel="stylesheet" href="/styles/custom.css" />
    <style>
      html {
        height: 100%;
        margin: 0;
        overflow: hidden;
        background: white;
        color: #666;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      }

      body {
        height: 100%;
        margin: 0;
        background: white;
        color: #666;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
        padding-top: 70px;
        display: flex;
        flex-direction: column;
        /* Default to auto overflow, we'll override for desktop */
        overflow: auto;
      }

      /* Desktop-specific scrolling behavior */
      @media (min-width: 1025px) {
        body {
          overflow: hidden;
        }
      }

      .page-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding-bottom: 70px;
        /* Default mobile-friendly values */
        height: auto;
        min-height: calc(100vh - 70px - 80px);
        overflow: visible;
      }

      /* Desktop-specific container behavior */
      @media (min-width: 1025px) {
        .page-wrapper {
          height: calc(100vh - 70px - 80px);
          overflow: hidden;
        }
      }

      /* Main container using CSS Grid for clean separation */
      .case-study-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        flex: 1;
        /* Default mobile-friendly values */
        /*height: auto;*/
        /*min-height: calc(100vh - 70px);*/
        min-height: auto;
        overflow: visible;
      }

      /* Desktop-specific grid behavior */
      @media (min-width: 1025px) {
        .case-study-container {
          flex: 1;
          overflow: hidden;
        }
      }

      /* Sidebar - Fixed position but within grid */
      .case-study-sidebar {
        background: linear-gradient(
          135deg,
          #4a3269 0%,
          #5a3f7e 25%,
          #6a4c93 50%,
          #7a6f9a 75%,
          #8a7ca8 100%
        );
        border-right: 1px solid rgba(0, 0, 0, 0.08);
        overflow-y: auto;
        overflow-x: hidden;
        padding: 2rem 0;
        z-index: 40;
      }

      /* Content area - Takes remaining space with its own scroll */
      .case-study-content {
        background: white;
        padding: 3rem 12% 3rem 12%;
        line-height: 1.5;
        position: relative;
        z-index: 1;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        /* Default mobile-friendly values */
        overflow: visible;
        height: auto;
      }

      /* Desktop-specific content scrolling */
      @media (min-width: 1025px) {
        .case-study-content {
          overflow-y: auto;
          overflow-x: hidden;
        }
      }

      /* Hamburger menu - hidden by default */
      .mobile-menu-toggle {
        display: none;
        position: fixed;
        top: 85px;
        left: 1rem;
        z-index: 60;
        background: linear-gradient(
          135deg,
          #4a3269 0%,
          #5a3f7e 25%,
          #6a4c93 50%,
          #7a6f9a 75%,
          #8a7ca8 100%
        );
        color: white;
        border: none;
        border-radius: 8px;
        width: 44px;
        height: 44px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
      }

      .mobile-menu-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      /* Hamburger icon */
      .hamburger {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      .hamburger span {
        display: block;
        width: 18px;
        height: 2px;
        background: white;
        margin: 2px 0;
        transition: all 0.3s ease;
        border-radius: 1px;
      }

      /* Better X animation when menu is open */
      .mobile-menu-toggle.open .hamburger span:nth-child(1) {
        transform: rotate(45deg) translate(4px, 4px);
        width: 18px;
      }

      .mobile-menu-toggle.open .hamburger span:nth-child(2) {
        opacity: 0;
        transform: scale(0);
      }

      .mobile-menu-toggle.open .hamburger span:nth-child(3) {
        transform: rotate(-45deg) translate(4px, -4px);
        width: 18px;
      }

      /* Mobile sidebar overlay */
      .mobile-sidebar-overlay {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 47;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.3s ease,
          visibility 0.3s ease;
        pointer-events: none;
      }

      .mobile-sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      /* Mobile sidebar */
      .mobile-sidebar {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 300px;
        height: calc(100vh - 70px);
        background: linear-gradient(
          135deg,
          #4a3269 0%,
          #5a3f7e 25%,
          #6a4c93 50%,
          #7a6f9a 75%,
          #8a7ca8 100%
        );
        z-index: 48;
        overflow-y: auto;
        transition: left 0.3s ease;
        box-shadow: none;
      }

      .mobile-sidebar.show {
        left: 0;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
      }

      /* When mobile menu is open, move the hamburger button to top-left of sidebar */
      .mobile-menu-toggle.open {
        left: 1rem;
        top: 85px;
        z-index: 65;
      }

      /* Yellow glow on hover when menu is open */
      .mobile-menu-toggle.open:hover {
        transform: translateY(-2px);
        box-shadow:
          0 0 20px rgba(241, 196, 15, 0.8),
          0 6px 16px rgba(0, 0, 0, 0.2);
        background: linear-gradient(
          135deg,
          #5a3f7e 0%,
          #6a4c93 25%,
          #7a6f9a 50%,
          #8a7ca8 75%,
          #9a8fb7 100%
        );
      }

      .mobile-sidebar .sidebar-content {
        padding: 5rem 1.5rem 2rem 1.5rem;
      }

      /* Mobile sidebar navigation styles */
      .mobile-sidebar .nav-section {
        margin-bottom: 0.25rem;
      }

      .mobile-sidebar .nav-item {
        display: block;
        padding: 0.75rem 1rem;
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        border-radius: 8px;
        margin: 0.125rem 0;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        position: relative;
      }

      .mobile-sidebar .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        transform: translateX(4px);
      }

      .mobile-sidebar .nav-item.active {
        background: rgba(255, 255, 255, 0.1);
        color: transparent;
        background-image: linear-gradient(
          135deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        font-weight: 600;
      }

      .mobile-sidebar .nav-item.parent {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        padding-left: 0.75rem;
      }

      .mobile-sidebar .nav-item.parent.expanded {
        background: rgba(255, 255, 255, 0.1);
        color: transparent;
        background-image: linear-gradient(
          135deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
      }

      .mobile-sidebar .nav-children {
        margin-left: 0.75rem;
        padding-left: 0.75rem;
        margin-bottom: 0.5rem;
        position: relative;
      }

      .mobile-sidebar .nav-children::before {
        content: "";
        position: absolute;
        left: -2px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(
          180deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
      }

      .mobile-sidebar .nav-children .anchor-link {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
        font-weight: 400;
        margin: 0.125rem 0;
        color: rgba(255, 255, 255, 0.8);
      }

      .mobile-sidebar .nav-children .anchor-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: transparent;
        background-image: linear-gradient(
          135deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        font-weight: 600;
      }

      .mobile-sidebar .nav-children .anchor-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: transparent;
        background-image: linear-gradient(
          135deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(230, 126, 34, 0.3);
      }

      .mobile-sidebar .expand-icon {
        display: inline-block;
        margin-right: 0.75rem;
        transition: transform 0.2s ease;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        width: 12px;
      }

      .mobile-sidebar .expand-icon.expanded {
        transform: rotate(90deg);
        color: #f39c12;
      }

      /* Content styling */
      .case-study-content h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #666;
        margin-bottom: 1.5rem;
        line-height: 1.2;
      }

      .case-study-content h2 {
        font-size: 2rem;
        font-weight: 600;
        color: #666;
        margin: 2.5rem 0 1.5rem 0;
        line-height: 1.3;
      }

      .case-study-content h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #666;
        margin: 2rem 0 1rem 0;
        line-height: 1.4;
      }

      .case-study-content p {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #666;
        margin-bottom: 1.5rem;
      }

      .case-study-content ul,
      .case-study-content ol {
        margin: 1.5rem 0;
        padding-left: 2rem;
      }

      .case-study-content li {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #666;
        margin-bottom: 0.5rem;
      }

      .case-study-content code {
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #e67e22;
        font-weight: 500;
      }

      .case-study-content pre {
        background: #1a1a1a;
        color: #e6e6e6;
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .case-study-content pre code {
        background: none;
        padding: 0;
        color: inherit;
        font-weight: normal;
      }

      .case-study-content blockquote {
        border-left: 4px solid #e67e22;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
        background: #fafafa;
        font-style: italic;
        color: #666;
      }

      .section-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 4rem 0 0 0;
        padding: 2rem 0 0.5rem 0;
        border-top: 1px solid #e5e7eb;
      }

      .nav-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: #f8f9fa;
        color: #666;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.15s ease;
        border: 1px solid #e5e7eb;
      }

      .nav-button:hover {
        background: linear-gradient(
          135deg,
          #e67e22 0%,
          #f39c12 30%,
          #f1c40f 70%,
          #f4d03f 100%
        );
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(230, 126, 34, 0.2);
      }

      .nav-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .nav-button-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .nav-button.next .nav-button-text {
        align-items: flex-end;
      }

      .nav-button-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.8;
      }

      .nav-button-title {
        font-size: 0.9rem;
        font-weight: 600;
      }

      /* Heading anchor adjustments */
      h2[id],
      h3[id] {
        scroll-margin-top: 90px;
        padding-top: 90px;
        margin-top: -90px;
      }

      /* Content wrapper to ensure footer stays at bottom */
      .content-wrapper {
        flex: 1;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        html {
          overflow: auto;
        }

        body {
          overflow: auto;
          height: auto;
          min-height: 100vh;
        }

        .page-wrapper {
          height: auto;
          min-height: calc(100vh - 70px);
          overflow: visible;
        }

        .case-study-container {
          display: block;
          height: auto;
          min-height: auto;
          overflow: visible;
        }

        .case-study-sidebar {
          display: none;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .mobile-sidebar-overlay {
          display: block;
        }

        .case-study-content {
          padding: 2rem 8%;
          padding-top: 4rem;
          overflow: visible;
          height: auto;
        }
      }

      /* Mobile phones */
      @media (max-width: 768px) {
        .case-study-content {
          padding: 1.5rem 7%;
          padding-top: 4rem;
        }

        .case-study-content h1 {
          font-size: 2rem;
        }

        .case-study-content h2 {
          font-size: 1.75rem;
        }
      }

      /* Very small screens */
      @media (max-width: 480px) {
        .case-study-content {
          padding: 1rem 6%;
          padding-top: 4rem;
        }
      }

      /* Custom scrollbar for sidebar */
      .case-study-sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .case-study-sidebar::-webkit-scrollbar-track {
        background: transparent;
      }

      .case-study-sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .case-study-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <Header />

    <!-- Mobile menu toggle button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
      <div class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>

    <!-- Mobile sidebar overlay -->
    <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

    <!-- Mobile sidebar -->
    <aside class="mobile-sidebar" id="mobileSidebar">
      <div class="sidebar-content">
        <nav>
          {
            navigation.map((section) => (
              <div class="nav-section">
                <a
                  href={section.link}
                  class={`nav-item parent ${shouldExpand(section) ? "expanded" : ""} ${isCurrentPage(section.link) ? "active" : ""}`}
                >
                  {section.anchors.length > 0 && (
                    <span
                      class={`expand-icon ${shouldExpand(section) ? "expanded" : ""}`}
                    >
                      ▶
                    </span>
                  )}
                  {section.label}
                </a>

                {section.anchors.length > 0 && shouldExpand(section) && (
                  <div class="nav-children">
                    {section.anchors.map((anchor) => (
                      <a
                        href={`${section.link}${anchor.anchor}`}
                        class="nav-item anchor-link"
                      >
                        {anchor.label}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            ))
          }
        </nav>
      </div>
    </aside>

    <div class="page-wrapper">
      <!-- Use CSS Grid for clean container separation -->
      <div class="case-study-container">
        <!-- Sidebar - First grid item -->
        <aside class="case-study-sidebar">
          <Sidebar />
        </aside>

        <!-- Main content - Second grid item -->
        <main class="case-study-content">
          <div class="content-wrapper">
            <slot />

            <nav class="section-navigation">
              {
                frontmatter.prevSection && (
                  <a href={frontmatter.prevPath} class="nav-button prev">
                    <span>←</span>
                    <div class="nav-button-text">
                      <span class="nav-button-label">Previous</span>
                      <span class="nav-button-title" id="prevTitle">
                        {frontmatter.prevSection}
                      </span>
                    </div>
                  </a>
                )
              }

              {!frontmatter.prevSection && <div />}

              {
                frontmatter.nextSection && (
                  <a href={frontmatter.nextPath} class="nav-button next">
                    <div class="nav-button-text">
                      <span class="nav-button-label">Next</span>
                      <span class="nav-button-title" id="nextTitle">
                        {frontmatter.nextSection}
                      </span>
                    </div>
                    <span>→</span>
                  </a>
                )
              }
            </nav>
          </div>
        </main>
      </div>
    </div>

    <script>
      // Mobile menu functionality
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuToggle = document.getElementById("mobileMenuToggle");
        const mobileSidebar = document.getElementById("mobileSidebar");
        const mobileSidebarOverlay = document.getElementById(
          "mobileSidebarOverlay",
        );

        function toggleMobileMenu() {
          const isOpen = mobileSidebar.classList.contains("show");

          if (isOpen) {
            // Close menu
            mobileMenuToggle.classList.remove("open");
            mobileSidebar.classList.remove("show");
            mobileSidebarOverlay.classList.remove("show");
          } else {
            // Open menu
            mobileMenuToggle.classList.add("open");
            mobileSidebar.classList.add("show");
            mobileSidebarOverlay.classList.add("show");
          }
        }

        // Toggle menu when button is clicked
        mobileMenuToggle.addEventListener("click", toggleMobileMenu);

        // Close menu when overlay is clicked
        mobileSidebarOverlay.addEventListener("click", toggleMobileMenu);

        // Close menu when a navigation link is clicked
        mobileSidebar.addEventListener("click", function (e) {
          if (e.target.tagName === "A") {
            toggleMobileMenu();
          }
        });

        // Close menu on window resize if screen gets large enough
        window.addEventListener("resize", function () {
          if (window.innerWidth > 1024) {
            mobileMenuToggle.classList.remove("open");
            mobileSidebar.classList.remove("show");
            mobileSidebarOverlay.classList.remove("show");
          }
        });

        // Original scroll highlight functionality
        const headings = document.querySelectorAll(
          "h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]",
        );
        headings.forEach((heading) => {
          heading.style.paddingTop = "90px";
          heading.style.marginTop = "-90px";
        });

        function addScrollListeners() {
          window.addEventListener("scroll", function () {
            throttledHighlight();
          });

          document.addEventListener("scroll", function () {
            throttledHighlight();
          });

          document.body.addEventListener("scroll", function () {
            throttledHighlight();
          });

          const mainContent = document.querySelector(".case-study-content");
          if (mainContent) {
            mainContent.addEventListener("scroll", function () {
              throttledHighlight();
            });
          }
        }

        function throttle(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        function highlightCurrentSection() {
          const headings = document.querySelectorAll("h2[id], h3[id]");
          const sidebarLinks = document.querySelectorAll(".anchor-link");

          let currentSection = null;

          // Convert headings to array and sort by position
          const headingArray = Array.from(headings)
            .map((heading) => ({
              id: heading.id,
              top: heading.getBoundingClientRect().top,
            }))
            .sort((a, b) => a.top - b.top);

          // Find the current section based on which heading has passed the top
          for (let i = 0; i < headingArray.length; i++) {
            const heading = headingArray[i];
            const nextHeading = headingArray[i + 1];

            // If this heading is above the threshold (200px from top)
            if (heading.top <= 200) {
              // And either there's no next heading or the next heading is still below the threshold
              if (!nextHeading || nextHeading.top > 200) {
                currentSection = heading.id;
                break;
              }
            }
          }

          // If no section found above, use the first visible section
          if (!currentSection && headingArray.length > 0) {
            const firstVisible = headingArray.find(
              (h) => h.top > 0 && h.top < window.innerHeight,
            );
            if (firstVisible) {
              currentSection = firstVisible.id;
            }
          }

          sidebarLinks.forEach((link) => {
            link.classList.remove("active");
            if (currentSection) {
              const linkHref = link.getAttribute("href");
              if (linkHref && linkHref.includes("#" + currentSection)) {
                link.classList.add("active");
              }
            }
          });
        }

        const throttledHighlight = throttle(highlightCurrentSection, 100);

        addScrollListeners();
        window.addEventListener("hashchange", highlightCurrentSection);
        setTimeout(highlightCurrentSection, 100);
      });
    </script>
  </body>
</html>
